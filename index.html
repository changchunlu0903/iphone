<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Final OS</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- 核心基础 --- */
        :root {
            --dock-height: 90px;
            --ios-bg: #f2f2f7;
            --ios-blue: #007aff;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; outline: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100dvh; overflow: hidden; background: #000; font-family: -apple-system, sans-serif; }

        /* 壁纸 */
        #wallpaper {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('https://images.unsplash.com/photo-1621574539437-4b7b48163cc4?q=80&w=2536&auto=format&fit=crop');
            background-size: cover; background-position: center; z-index: 1;
        }

        /* --- 锁屏层 (z-index: 2000) --- */
        #lock-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 2000; display: flex; flex-direction: column; align-items: center;
            padding-top: 15vh; color: white;
            transition: transform 0.4s ease-in-out;
            background: rgba(0,0,0,0.2); backdrop-filter: blur(0px);
        }
        .clock-big { font-size: 80px; font-weight: 200; text-shadow: 0 5px 20px rgba(0,0,0,0.2); }
        .date-text { font-size: 20px; font-weight: 500; margin-top: -10px; }
        .unlock-hint { margin-top: auto; margin-bottom: 50px; opacity: 0.8; animation: bounce 2s infinite; font-size: 14px; }
        @keyframes bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }

        /* --- 密码层 (z-index: 3000) --- */
        #pass-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 3000; background: rgba(0,0,0,0.6); backdrop-filter: blur(30px);
            display: none; /* JS控制显示 */
            flex-direction: column; align-items: center; justify-content: center;
        }
        .pass-dots { display: flex; gap: 20px; margin-bottom: 50px; }
        .p-dot { width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; transition: 0.2s; }
        .p-dot.fill { background: white; }
        .numpad { display: grid; grid-template-columns: repeat(3, 80px); gap: 25px; }
        .num-btn { width: 80px; height: 80px; border-radius: 50%; background: rgba(255,255,255,0.2); color: white; font-size: 28px; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        .num-btn:active { background: rgba(255,255,255,0.4); }

        /* --- 桌面层 (z-index: 100) --- */
        #desktop {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 100; display: flex; flex-direction: column; padding-top: 40px;
        }
        .desktop-area { flex: 1; display: grid; grid-template-columns: repeat(4, 1fr); grid-auto-rows: max-content; gap: 20px; padding: 20px; justify-items: center; }
        .dock {
            height: var(--dock-height); margin: 0 15px 15px 15px;
            background: rgba(255,255,255,0.3); backdrop-filter: blur(40px);
            border-radius: 35px; display: flex; justify-content: space-around; align-items: center;
        }
        .app-icon { width: 60px; height: 60px; border-radius: 14px; display: flex; justify-content: center; align-items: center; font-size: 30px; color: white; cursor: pointer; position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .app-icon img { width: 100%; height: 100%; border-radius: 14px; object-fit: cover; }
        .app-text { color: white; font-size: 12px; margin-top: 5px; text-shadow: 0 1px 2px rgba(0,0,0,0.8); text-align: center; }
        .app-wrap { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        
        .ico-qq { background: #0099ff; }
        .ico-wx { background: #34c759; }
        .ico-set { background: #8e8e93; }
        .ico-br { background: white; color: #007aff; }
        .ico-book { background: #a2845e; }

        /* --- APP 通用窗口 (z-index: 500) --- */
        .app-win {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--ios-bg); z-index: 500; 
            display: none; /* 默认隐藏 */
            flex-direction: column;
            animation: appOpen 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        @keyframes appOpen { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* 顶部导航 (去除状态栏留白) */
        .nav {
            height: 50px; background: #f9f9f9; display: flex; justify-content: space-between; align-items: center; padding: 0 15px;
            border-bottom: 0.5px solid #ccc; flex-shrink: 0; z-index: 10;
        }
        .nav-btn { color: var(--ios-blue); font-size: 16px; cursor: pointer; padding: 10px; }
        .nav-title { font-weight: 600; font-size: 17px; }
        
        .content-scroll { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-bottom: 30px; }

        /* --- QQ 特有样式 --- */
        .qq-header { height: 50px; background: linear-gradient(90deg, #00b4ff, #0099ff); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; color: white; flex-shrink: 0; }
        .qq-search { background: #f5f6fa; padding: 10px; }
        .qq-search-in { background: white; height: 36px; border-radius: 6px; display: flex; justify-content: center; align-items: center; color: #aaa; font-size: 14px; }
        .qq-footer { height: 55px; background: #fbfbfb; border-top: 0.5px solid #ddd; display: flex; flex-shrink: 0; }
        .qq-tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #7f7f7f; cursor: pointer; }
        .qq-tab-item.active { color: #0099ff; }
        .qq-badge { background: #ff3b30; color: white; font-size: 10px; padding: 2px 5px; border-radius: 10px; position: absolute; top: -5px; right: -8px; }

        .qq-row { display: flex; padding: 12px 15px; background: white; border-bottom: 0.5px solid #f0f0f0; align-items: center; cursor: pointer; }
        .qq-row:active { background: #f5f5f5; }
        .qq-av { width: 45px; height: 45px; border-radius: 50%; margin-right: 12px; background-size: cover; flex-shrink: 0; }
        .qq-info { flex: 1; overflow: hidden; }
        
        /* 页面切换逻辑 */
        .qq-page-view { display: none; height: 100%; flex-direction: column; overflow-y: auto; }
        .qq-page-view.show { display: flex; }

        /* --- 通讯录样式 --- */
        .contact-row { display: flex; align-items: center; padding: 10px 15px; background: white; border-bottom: 0.5px solid #eee; height: 60px; }
        .contact-btn { width: 36px; height: 36px; background: #f2f2f7; border-radius: 50%; color: #007aff; display: flex; justify-content: center; align-items: center; }

        /* --- 聊天窗口 (z-index: 800) --- */
        .chat-view {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #efeff4; z-index: 800; transform: translateX(100%); transition: transform 0.3s;
            display: flex; flex-direction: column;
        }
        .chat-body { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .bubble { max-width: 75%; padding: 10px 14px; border-radius: 14px; font-size: 16px; line-height: 1.4; word-wrap: break-word; }
        .bubble.me { align-self: flex-end; background: #007aff; color: white; }
        .bubble.other { align-self: flex-start; background: white; color: black; }

        /* --- 底部条 --- */
        .home-bar { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); width: 130px; height: 5px; background: rgba(0,0,0,0.3); border-radius: 10px; z-index: 9999; cursor: pointer; }

        /* --- 表单样式 --- */
        .form-g { background: white; padding: 0 15px; margin-bottom: 20px; }
        .form-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 0.5px solid #eee; }
        .form-input { text-align: right; border: none; font-size: 16px; color: #007aff; width: 60%; background: transparent; }
        .btn-act { background: #007aff; color: white; text-align: center; padding: 12px; margin: 10px 15px; border-radius: 10px; font-size: 16px; font-weight: 500; cursor: pointer; }
    </style>
</head>
<body>

    <div id="wallpaper"></div>

    <div id="lock-screen" onclick="tryUnlock()">
        <div class="clock-big" id="ls-time">12:00</div>
        <div class="date-text" id="ls-date">12月17日 星期三</div>
        <div class="unlock-hint">向上轻扫以解锁</div>
    </div>

    <div id="pass-layer">
        <h3 style="color:white; margin-bottom:30px; font-weight:400;" id="pass-msg">输入密码</h3>
        <div class="pass-dots"><div class="p-dot"></div><div class="p-dot"></div><div class="p-dot"></div><div class="p-dot"></div></div>
        <div class="numpad" id="numpad"></div>
    </div>

    <div id="desktop">
        <div class="desktop-area">
            <div class="app-wrap" onclick="openApp('qq')">
                <div class="app-icon ico-qq"><i class="fab fa-qq"></i></div>
                <div class="app-text">QQ</div>
            </div>
            <div class="app-wrap" onclick="openApp('lore')">
                <div class="app-icon ico-book"><i class="fas fa-book"></i></div>
                <div class="app-text">世界书</div>
            </div>
        </div>
        <div class="dock">
            <div class="app-icon ico-wx" onclick="openApp('phone')"><i class="fas fa-phone-alt"></i></div>
            <div class="app-icon ico-br" onclick="openApp('browser')"><i class="fab fa-safari"></i></div>
            <div class="app-icon ico-set" onclick="openApp('settings')"><i class="fas fa-cog"></i></div>
        </div>
        <div class="home-bar"></div>
    </div>

    <div id="app-qq" class="app-win" style="background: white;">
        <div class="qq-header">
            <div style="width:32px; height:32px; background:url('https://api.dicebear.com/7.x/avataaars/svg?seed=Me') center/cover; border-radius:50%; border:1px solid white;"></div>
            <div style="font-size:17px; font-weight:600;" id="qq-title-text">消息</div>
            <i class="fas fa-plus" style="font-size:20px; cursor:pointer;" onclick="openCreator()"></i>
        </div>
        
        <div class="qq-search"><div class="qq-search-in"><i class="fas fa-search" style="margin-right:5px;"></i> 搜索</div></div>

        <div style="flex:1; position:relative; overflow:hidden;">
            <div id="tab-msg" class="qq-page-view show">
                <div class="content-scroll" id="qq-chat-list"></div>
            </div>
            <div id="tab-contact" class="qq-page-view">
                <div class="qq-row" style="height:50px;"><div class="qq-av" style="border-radius:8px; background:#fa9d3b; display:flex; justify-content:center; align-items:center; color:white;">新</div><div>新朋友</div></div>
                <div class="content-scroll" id="qq-contact-inner"></div>
            </div>
            <div id="tab-zone" class="qq-page-view">
                <div class="qq-row"><i class="fas fa-star" style="color:#ffc900; margin-right:15px; font-size:20px;"></i>好友动态</div>
                <div class="qq-row"><i class="fas fa-gamepad" style="color:#ff3b30; margin-right:15px; font-size:20px;"></i>游戏中心</div>
            </div>
        </div>

        <div class="qq-footer">
            <div class="qq-tab-item active" onclick="switchQQ('msg', this)">
                <div style="position:relative;"><i class="fas fa-comment" style="font-size:24px;"></i><div class="qq-badge">1</div></div>
                <div style="font-size:10px;">消息</div>
            </div>
            <div class="qq-tab-item" onclick="switchQQ('contact', this)">
                <i class="fas fa-user-friends" style="font-size:24px;"></i><div style="font-size:10px;">联系人</div>
            </div>
            <div class="qq-tab-item" onclick="switchQQ('zone', this)">
                <i class="far fa-compass" style="font-size:24px;"></i><div style="font-size:10px;">动态</div>
            </div>
        </div>
        <div class="home-bar"></div>
    </div>

    <div id="app-phone" class="app-win">
        <div class="nav">
            <div class="nav-btn" onclick="closeApp('phone')">关闭</div>
            <div class="nav-title">通讯录</div>
            <div class="nav-btn" onclick="openCreator()"><i class="fas fa-plus"></i></div>
        </div>
        <div class="content-scroll" id="phone-list-real"></div>
        <div class="home-bar"></div>
    </div>

    <div id="app-browser" class="app-win">
        <div class="nav">
            <div class="nav-btn" onclick="closeApp('browser')">关闭</div>
            <div class="nav-title">浏览器</div>
            <div class="nav-btn" onclick="doSearch()">搜索</div>
        </div>
        <div style="padding:10px; background:#eee;"><input id="browser-input" style="width:100%; padding:8px; border-radius:8px; border:none; text-align:center;" placeholder="输入网址..."></div>
        <div class="content-scroll" id="browser-res" style="background:white; padding:20px; text-align:center; color:#888;">
            <i class="fab fa-google" style="font-size:40px; margin-bottom:10px;"></i><br>AI 搜索已就绪
        </div>
        <div class="home-bar"></div>
    </div>

    <div id="app-settings" class="app-win">
        <div class="nav"><div class="nav-btn" onclick="closeApp('settings')">关闭</div><div class="nav-title">设置</div><div></div></div>
        <div class="content-scroll">
            <div class="form-g" style="margin-top:20px;">
                <div class="form-row"><span>配置名称</span><input id="cfg-name" class="form-input" placeholder="默认配置"></div>
            </div>
            <div class="form-g">
                <div class="form-row"><span>API地址</span><input id="cfg-url" class="form-input" placeholder="https://api.openai.com/v1"></div>
                <div class="form-row"><span>API Key</span><input id="cfg-key" type="password" class="form-input"></div>
                <div class="form-row"><span>模型</span><input id="cfg-model" class="form-input" placeholder="gpt-3.5-turbo"></div>
            </div>
            <div class="form-g" style="padding:15px;">
                <div style="font-size:12px; color:#888;">预设 (System Preset)</div>
                <textarea id="cfg-pre" style="width:100%; border:1px solid #eee; margin-top:5px; height:60px;"></textarea>
                <div style="font-size:12px; color:#888; margin-top:10px;">破限 (Depth Prompt)</div>
                <textarea id="cfg-depth" style="width:100%; border:1px solid #eee; margin-top:5px; height:60px;"></textarea>
            </div>
            <div class="btn-act" onclick="saveSys()">保存配置</div>
            <div class="btn-act" style="background:#34c759;" onclick="exportData()">导出备份</div>
            <div class="btn-act" style="background:#ff9500;" onclick="document.getElementById('imp-file').click()">导入备份</div>
            <input type="file" id="imp-file" style="display:none" onchange="importData(this)">
            <div class="btn-act" style="background:#ff3b30;" onclick="if(confirm('重置?')) localStorage.clear();location.reload();">重置所有数据</div>
        </div>
        <div class="home-bar"></div>
    </div>

    <div id="app-lore" class="app-win">
        <div class="nav"><div class="nav-btn" onclick="closeApp('lore')">关闭</div><div class="nav-title">世界书</div><div class="nav-btn" onclick="newLore()">+</div></div>
        <div class="content-scroll" id="lore-list"></div>
        <div class="home-bar"></div>
    </div>

    <div id="chat-view" class="chat-view">
        <div class="nav">
            <div class="nav-btn" onclick="closeChat()">返回</div>
            <div class="nav-title" id="chat-title">Chat</div>
            <div class="nav-btn"><i class="fas fa-user"></i></div>
        </div>
        <div class="chat-body" id="chat-box"></div>
        <div style="padding:10px; background:#f9f9f9; display:flex; gap:10px; padding-bottom:30px;">
            <input id="msg-input" style="flex:1; padding:10px; border-radius:20px; border:1px solid #ccc;" placeholder="发消息...">
            <button onclick="sendMsg()" style="border:none; color:#007aff; font-weight:bold;">发送</button>
        </div>
    </div>

    <script>
        /* --- 核心逻辑 --- */
        let sys = { pass:null, name:'Config1', api:'', key:'', model:'gpt-3.5-turbo', preset:'', depth:'' };
        let data = { users:[], worlds:[], chats:{} };
        let tempPass = [];
        let isSetup = false;
        let activeUid = null;

        // 初始化
        window.onload = function() {
            loadAll();
            updateClock(); setInterval(updateClock, 1000);
            
            // 绑定 Home Bar 关闭所有
            document.querySelectorAll('.home-bar').forEach(b => {
                b.onclick = (e) => {
                    e.stopPropagation();
                    document.querySelectorAll('.app-win').forEach(w => w.style.display='none');
                    closeChat();
                };
            });
            
            // 绑定回车
            document.getElementById('msg-input').onkeypress = (e) => { if(e.key==='Enter') sendMsg(); };
            document.getElementById('browser-input').onkeypress = (e) => { if(e.key==='Enter') doSearch(); };
        };

        function updateClock() {
            const d = new Date();
            const t = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
            document.getElementById('ls-time').innerText = t;
        }

        /* --- 锁屏与密码 --- */
        function tryUnlock() {
            document.getElementById('lock-screen').style.transform = 'translateY(-100%)';
            document.getElementById('pass-layer').style.display = 'flex';
            initPassPad();
            isSetup = !sys.pass;
            document.getElementById('pass-msg').innerText = isSetup ? "设置新密码" : "输入密码";
            tempPass = []; updateDots();
        }

        function initPassPad() {
            const p = document.getElementById('numpad'); p.innerHTML = '';
            [1,2,3,4,5,6,7,8,9,0].forEach(n => {
                const b = document.createElement('div'); b.className='num-btn'; b.innerText=n;
                b.onclick = (e) => { e.stopPropagation(); inputPass(n); };
                if(n===0) b.style.gridColumnStart='2';
                p.appendChild(b);
            });
            // 增加退格/取消键
            const c = document.createElement('div'); c.innerText='取消'; c.style='color:white; display:flex; justify-content:center; align-items:center; cursor:pointer; font-size:14px;';
            c.onclick = (e) => { e.stopPropagation(); document.getElementById('pass-layer').style.display='none'; document.getElementById('lock-screen').style.transform='translateY(0)'; };
            p.appendChild(c);
        }

        function inputPass(n) {
            if(tempPass.length < 4) {
                tempPass.push(n); updateDots();
                if(tempPass.length === 4) setTimeout(checkPass, 100);
            }
        }
        function updateDots() {
            document.querySelectorAll('.p-dot').forEach((d,i) => d.style.background = i<tempPass.length?'white':'transparent');
        }
        function checkPass() {
            const code = tempPass.join('');
            if(isSetup) {
                sys.pass = code; saveAll(); alert("密码已设置");
                document.getElementById('pass-layer').style.display='none';
            } else {
                if(code == sys.pass) document.getElementById('pass-layer').style.display='none';
                else { alert("密码错误"); tempPass=[]; updateDots(); }
            }
        }

        /* --- APP 管理 --- */
        function openApp(id) {
            const el = document.getElementById('app-'+id);
            if(el) {
                el.style.display = 'flex'; el.style.zIndex = '600';
                if(id==='qq') renderQQ();
                if(id==='phone') renderPhone();
                if(id==='settings') loadSettingsUI();
                if(id==='lore') renderLore();
            }
        }
        function closeApp(id) { document.getElementById('app-'+id).style.display='none'; }

        /* --- QQ 逻辑 --- */
        function switchQQ(tab, el) {
            document.querySelectorAll('.qq-tab-item').forEach(t=>t.classList.remove('active'));
            el.classList.add('active');
            document.querySelectorAll('.qq-page-view').forEach(p=>p.classList.remove('show'));
            document.getElementById('tab-'+tab).classList.add('show');
            document.getElementById('qq-title-text').innerText = (tab==='msg'?'消息':(tab==='contact'?'联系人':'动态'));
        }

        function renderQQ() {
            const list = document.getElementById('qq-chat-list'); list.innerHTML='';
            const clist = document.getElementById('qq-contact-inner'); clist.innerHTML='';
            
            data.users.forEach(u => {
                // 1. 消息列表
                const msgs = data.chats[u.id] || [];
                const last = msgs.length ? msgs[msgs.length-1].content : "暂无消息";
                const d1 = document.createElement('div'); d1.className='qq-row';
                d1.onclick = ()=>enterChat(u.id);
                d1.innerHTML = `<div class="qq-av" style="background-image:url('${u.avatar}')"></div><div class="qq-info"><div style="display:flex;justify-content:space-between;"><span style="font-size:16px;color:#000;">${u.name}</span><span style="font-size:12px;color:#999;">刚刚</span></div><div style="font-size:13px;color:#888;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${last}</div></div>`;
                list.appendChild(d1);

                // 2. 联系人列表
                const d2 = document.createElement('div'); d2.className='qq-row';
                d2.onclick = ()=>alert("查看资料卡: "+u.name);
                d2.innerHTML = `<div class="qq-av" style="background-image:url('${u.avatar}');width:36px;height:36px;"></div><div style="font-size:16px;">${u.name}</div>`;
                clist.appendChild(d2);
            });
        }

        /* --- 聊天功能 --- */
        function enterChat(uid) {
            activeUid = uid;
            const u = data.users.find(x=>x.id===uid);
            document.getElementById('chat-title').innerText = u.name;
            document.getElementById('chat-view').style.transform = 'translateX(0)';
            renderMsg();
        }
        function closeChat() { document.getElementById('chat-view').style.transform = 'translateX(100%)'; renderQQ(); }
        
        function renderMsg() {
            const box = document.getElementById('chat-box'); box.innerHTML='';
            (data.chats[activeUid]||[]).forEach(m => {
                const b = document.createElement('div'); b.className = `bubble ${m.role}`; b.innerText = m.content;
                box.appendChild(b);
            });
            box.scrollTop = box.scrollHeight;
        }

        async function sendMsg() {
            const txt = document.getElementById('msg-input').value.trim();
            if(!txt || !activeUid) return;
            if(!data.chats[activeUid]) data.chats[activeUid]=[];
            data.chats[activeUid].push({role:'me', content:txt});
            document.getElementById('msg-input').value='';
            renderMsg();

            // AI Call
            try {
                const u = data.users.find(x=>x.id===activeUid);
                let prompt = `你扮演 ${u.name}。\n人设:${u.persona||''}\n`;
                if(sys.preset) prompt = sys.preset + '\n' + prompt;
                if(u.world) { const w = data.worlds.find(x=>x.id==u.world); if(w) prompt+=`\n世界观:${w.content}`; }
                
                const msgs = [{role:'system', content:prompt}];
                data.chats[activeUid].forEach(m=> msgs.push({role:m.role=='me'?'user':'assistant', content:m.content}));
                if(sys.depth) msgs.push({role:'system', content:sys.depth}); // Depth prompt at end

                const res = await fetch(sys.api + (sys.api.endsWith('/v1')?'/chat/completions':'/v1/chat/completions'), {
                    method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+sys.key},
                    body: JSON.stringify({model:sys.model, messages:msgs})
                });
                const json = await res.json();
                const reply = json.choices[0].message.content;
                data.chats[activeUid].push({role:'other', content:reply});
                renderMsg();
            } catch(e) { alert("AI Error: "+e.message); }
            saveAll();
        }

        /* --- 其他功能 --- */
        function openCreator() {
            const name = prompt("角色名:"); if(!name) return;
            const persona = prompt("人设:");
            const wid = prompt("关联世界书ID (可选):");
            data.users.push({id:Date.now()+'', name, persona, avatar:`https://api.dicebear.com/7.x/avataaars/svg?seed=${name}`, world:wid});
            saveAll(); renderQQ();
        }
        function newLore() {
            const t = prompt("标题:"); if(!t) return;
            const c = prompt("内容:");
            data.worlds.push({id:Date.now()+'', title:t, content:c});
            saveAll(); renderLore();
        }
        function renderLore() {
            const l = document.getElementById('lore-list'); l.innerHTML='';
            data.worlds.forEach(w => l.innerHTML+=`<div style="padding:15px;border-bottom:1px solid #eee;"><b>${w.title}</b><div style="color:#666;font-size:12px;">ID: ${w.id}</div></div>`);
        }
        function renderPhone() {
            const p = document.getElementById('phone-list-real'); p.innerHTML='';
            data.users.forEach(u => p.innerHTML+=`<div class="contact-row"><div style="width:36px;height:36px;border-radius:50%;background:url('${u.avatar}');margin-right:10px;"></div><div style="flex:1;font-weight:bold;">${u.name}</div><div class="contact-btn"><i class="fas fa-phone"></i></div></div>`);
        }
        
        function doSearch() {
            const q = document.getElementById('browser-input').value;
            document.getElementById('browser-res').innerText = "正在搜索: " + q + " ...\n(此处接入AI搜索API)";
        }

        /* --- 数据存取 --- */
        function loadAll() {
            const s = localStorage.getItem('os_sys'); if(s) sys = JSON.parse(s);
            const d = localStorage.getItem('os_data'); if(d) data = JSON.parse(d);
        }
        function saveAll() {
            localStorage.setItem('os_sys', JSON.stringify(sys));
            localStorage.setItem('os_data', JSON.stringify(data));
        }
        function loadSettingsUI() {
            document.getElementById('cfg-name').value = sys.name;
            document.getElementById('cfg-url').value = sys.api;
            document.getElementById('cfg-key').value = sys.key;
            document.getElementById('cfg-model').value = sys.model;
            document.getElementById('cfg-pre').value = sys.preset;
            document.getElementById('cfg-depth').value = sys.depth;
        }
        function saveSys() {
            sys.name = document.getElementById('cfg-name').value;
            sys.api = document.getElementById('cfg-url').value;
            sys.key = document.getElementById('cfg-key').value;
            sys.model = document.getElementById('cfg-model').value;
            sys.preset = document.getElementById('cfg-pre').value;
            sys.depth = document.getElementById('cfg-depth').value;
            saveAll(); alert("保存成功"); closeApp('settings');
        }
        function exportData() {
            const blob = new Blob([JSON.stringify({sys,data})], {type:'application/json'});
            const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='backup.json'; a.click();
        }
        function importData(el) {
            const r = new FileReader();
            r.onload = e => { 
                const j = JSON.parse(e.target.result); sys=j.sys; data=j.data; saveAll(); location.reload(); 
            };
            r.readAsText(el.files[0]);
        }
    </script>
</body>
</html>
