<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>OS Pro</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --dock-height: 90px;
            --bg-color: #000;
            --ios-bg: #f2f2f7;
            --ios-card: #ffffff;
            --ios-blue: #007aff;
            --ios-red: #ff3b30;
            --ios-gray: #8e8e93;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; outline: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100dvh; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #000; color: #000; }

        /* --- 基础层级 --- */
        #wallpaper {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('https://images.unsplash.com/photo-1621574539437-4b7b48163cc4?q=80&w=2536&auto=format&fit=crop');
            background-size: cover; background-position: center; z-index: 1;
        }
        
        /* 状态栏 */
        .status-bar {
            position: absolute; top: 0; left: 0; width: 100%; height: 44px;
            padding-top: var(--safe-top); display: flex; justify-content: space-between; align-items: center;
            padding-left: 20px; padding-right: 20px; color: white; font-weight: 600; font-size: 14px; z-index: 1000;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        /* 锁屏 */
        #lock-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000;
            display: flex; flex-direction: column; align-items: center; padding-top: 15vh; color: white;
            transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); backdrop-filter: blur(0);
        }
        .clock-big { font-size: 80px; font-weight: 200; text-shadow: 0 5px 20px rgba(0,0,0,0.2); }
        .date-text { font-size: 20px; font-weight: 500; margin-top: -10px; }

        /* 密码盘 */
        #pass-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1900;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(30px); display: none;
            flex-direction: column; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s;
        }
        .pass-dots { display: flex; gap: 20px; margin-bottom: 50px; }
        .p-dot { width: 12px; height: 12px; border-radius: 50%; border: 1.5px solid white; transition: 0.2s; }
        .p-dot.fill { background: white; }
        .numpad { display: grid; grid-template-columns: repeat(3, 80px); gap: 25px; }
        .num-btn { width: 80px; height: 80px; border-radius: 50%; background: rgba(255,255,255,0.2); color: white; font-size: 30px; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        .num-btn:active { background: rgba(255,255,255,0.5); }

        /* --- 桌面 --- */
        #desktop {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100;
            padding-top: calc(44px + var(--safe-top)); display: flex; flex-direction: column;
        }

        /* 上部应用区 (QQ) */
        .desktop-main { flex: 1; padding: 20px; display: grid; grid-template-columns: repeat(4, 1fr); grid-auto-rows: max-content; gap: 20px; justify-items: center; }
        
        /* 底部 Dock */
        .dock {
            height: var(--dock-height); margin: 0 15px 15px 15px;
            background: rgba(255,255,255,0.3); backdrop-filter: blur(40px);
            border-radius: 35px; display: flex; justify-content: space-around; align-items: center;
            margin-bottom: max(15px, var(--safe-bottom));
        }

        .icon { width: 60px; height: 60px; border-radius: 14px; display: flex; justify-content: center; align-items: center; font-size: 30px; color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); position: relative; cursor: pointer; transition: transform 0.1s; }
        .icon:active { transform: scale(0.9); }
        .icon img { width: 100%; height: 100%; object-fit: cover; border-radius: 14px; }
        .icon-name { font-size: 12px; color: white; margin-top: 5px; text-shadow: 0 1px 2px rgba(0,0,0,0.8); text-align: center; }
        .app-wrap { display: flex; flex-direction: column; align-items: center; }

        .ico-qq { background: #0099ff; }
        .ico-phone { background: #34c759; }
        .ico-book { background: #a2845e; } /* 世界书颜色 */
        .ico-browser { background: white; color: #007aff; }
        .ico-settings { background: #8e8e93; }

        /* --- App 窗口框架 --- */
        .app-win {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--ios-bg); z-index: 500; display: none; flex-direction: column;
            animation: openApp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        @keyframes openApp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .nav {
            height: 50px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
            border-bottom: 0.5px solid #ccc; display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; padding-top: var(--safe-top); height: calc(50px + var(--safe-top));
            flex-shrink: 0; z-index: 10;
        }
        .nav-title { font-weight: 600; font-size: 17px; }
        .nav-btn { color: var(--ios-blue); font-size: 16px; background: none; border: none; padding: 10px; cursor: pointer; }

        .content-scroll { flex: 1; overflow-y: auto; padding-bottom: 30px; }
        .home-bar { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); width: 130px; height: 5px; background: #000; border-radius: 10px; opacity: 0.3; z-index: 9999; cursor: pointer;}

        /* --- 列表通用样式 --- */
        .list-group { background: white; margin-top: 20px; border-top: 0.5px solid #ddd; border-bottom: 0.5px solid #ddd; }
        .list-item {
            display: flex; align-items: center; padding: 12px 15px; border-bottom: 0.5px solid #eee; margin-left: 15px; padding-left: 0;
            background: white;
        }
        .list-item:last-child { border-bottom: none; }
        .list-item:active { background: #f2f2f2; }
        
        .av-small { width: 40px; height: 40px; border-radius: 50%; background: #eee center/cover; margin-right: 12px; }
        .txt-main { font-size: 16px; font-weight: 500; color: #000; }
        .txt-sub { font-size: 13px; color: #888; margin-top: 2px; }

        /* --- 创作者表单样式 (Creator) --- */
        .form-section { margin: 20px 15px; }
        .form-header { font-size: 13px; color: #666; margin-bottom: 8px; margin-left: 10px; text-transform: uppercase; }
        .form-card { background: white; border-radius: 10px; overflow: hidden; }
        .form-row { display: flex; padding: 12px 15px; border-bottom: 0.5px solid #eee; align-items: center; }
        .form-row:last-child { border-bottom: none; }
        .form-label { width: 80px; font-size: 16px; color: #000; }
        .form-input { flex: 1; border: none; font-size: 16px; text-align: right; color: var(--ios-blue); background: transparent; }
        .form-textarea { width: 100%; border: none; font-size: 15px; line-height: 1.4; resize: none; min-height: 80px; margin-top: 5px; font-family: inherit; }
        
        /* 图片上传预览 */
        .img-upload-box { display: flex; flex-direction: column; align-items: center; margin: 20px 0; }
        .img-preview { width: 100px; height: 100px; border-radius: 50%; background: #ddd center/cover; border: 3px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 10px; }
        .btn-upload { font-size: 14px; color: var(--ios-blue); }

        /* --- Action Sheet (底部弹窗菜单) --- */
        .action-sheet-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 2000;
            display: none; flex-direction: column; justify-content: flex-end;
        }
        .action-sheet {
            background: #f2f2f7; border-top-left-radius: 15px; border-top-right-radius: 15px; padding: 20px; padding-bottom: max(20px, var(--safe-bottom));
            transform: translateY(100%); transition: transform 0.3s;
        }
        .action-btn {
            background: white; width: 100%; padding: 15px; border-radius: 12px; text-align: center;
            font-size: 18px; color: var(--ios-blue); margin-bottom: 10px; font-weight: 500;
        }
        .action-cancel { font-weight: 600; color: var(--ios-red); margin-bottom: 0; }

        /* --- 聊天界面 --- */
        .chat-view {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #efeff4; z-index: 800;
            display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s;
        }
        .chat-body { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .bubble { max-width: 75%; padding: 10px 14px; border-radius: 16px; font-size: 16px; line-height: 1.5; word-wrap: break-word; }
        .bubble.me { align-self: flex-end; background: #007aff; color: white; border-bottom-right-radius: 4px; }
        .bubble.ai { align-self: flex-start; background: white; color: black; border-bottom-left-radius: 4px; }

    </style>
</head>
<body>

    <div id="wallpaper"></div>
    <div class="status-bar">
        <span id="sb-time">12:00</span>
        <span><i class="fas fa-signal"></i> <i class="fas fa-wifi"></i> <i class="fas fa-battery-full"></i></span>
    </div>

    <div id="lock-screen" onclick="tryUnlock()">
        <div class="clock-big" id="lock-time">12:00</div>
        <div class="date-text" id="lock-date">12月17日 星期三</div>
        <div style="margin-top:auto; margin-bottom: 50px; opacity: 0.8; animation: bounce 2s infinite;">向上轻扫以解锁</div>
    </div>

    <div id="pass-layer">
        <h3 style="color:white; margin-bottom:30px;" id="pass-hint">输入密码</h3>
        <div class="pass-dots"><div class="p-dot"></div><div class="p-dot"></div><div class="p-dot"></div><div class="p-dot"></div></div>
        <div class="numpad" id="numpad"></div>
    </div>

    <div id="desktop">
        <div class="desktop-main">
            <div class="app-wrap" onclick="openApp('qq')">
                <div class="icon ico-qq"><img src="https://cdn-icons-png.flaticon.com/512/2111/2111604.png"></div>
                <div class="icon-name">QQ</div>
            </div>
            <div class="app-wrap" onclick="openApp('lore')">
                <div class="icon ico-book"><i class="fas fa-book-journal-whills"></i></div>
                <div class="icon-name">世界书</div>
            </div>
        </div>

        <div class="dock">
            <div class="icon ico-phone" onclick="openApp('phone')"><i class="fas fa-address-book"></i></div>
            <div class="icon ico-browser" onclick="openApp('browser')"><i class="fab fa-safari"></i></div>
            <div class="icon ico-settings" onclick="openApp('settings')"><i class="fas fa-cog"></i></div>
        </div>
        <div class="home-bar on-desk"></div>
    </div>

    <div id="app-qq" class="app-win">
        <div class="nav" style="background:#f9f9f9;">
            <div class="av-small" style="background-image:url('https://api.dicebear.com/7.x/avataaars/svg?seed=Me')" onclick="alert('个人主页功能')"></div>
            <div class="nav-title">消息</div>
            <div class="nav-btn" onclick="openActionSheet()"><i class="fas fa-plus"></i></div>
        </div>
        <div class="content-scroll" id="qq-list"></div>
        <div class="home-bar"></div>
    </div>

    <div id="app-phone" class="app-win">
        <div class="nav">
            <div class="nav-btn" onclick="closeApp('phone')">关闭</div>
            <div class="nav-title">通讯录</div>
            <div class="nav-btn" onclick="openActionSheet()"><i class="fas fa-plus"></i></div>
        </div>
        <div class="content-scroll">
            <div class="list-group" id="phone-list"></div>
        </div>
        <div class="home-bar"></div>
    </div>

    <div id="app-lore" class="app-win">
        <div class="nav">
            <div class="nav-btn" onclick="closeApp('lore')">关闭</div>
            <div class="nav-title">世界书管理</div>
            <div class="nav-btn" onclick="openCreateWorld()">新建</div>
        </div>
        <div class="content-scroll">
            <div style="padding:15px; color:#888; font-size:13px;">管理你的世界观背景，创建人物时可关联。</div>
            <div class="list-group" id="lore-list"></div>
        </div>
        <div class="home-bar"></div>
    </div>

    <div id="app-settings" class="app-win">
        <div class="nav"><div class="nav-btn" onclick="closeApp('settings')">关闭</div><div class="nav-title">设置</div><div></div></div>
        <div class="content-scroll">
            <div class="form-section">
                <div class="form-header">API 配置</div>
                <div class="form-card">
                    <div class="form-row"><span class="form-label">地址</span><input id="cfg-url" class="form-input" placeholder="https://api.openai.com/v1"></div>
                    <div class="form-row"><span class="form-label">Key</span><input id="cfg-key" type="password" class="form-input" placeholder="sk-..."></div>
                    <div class="form-row"><span class="form-label">模型</span><input id="cfg-model" class="form-input" placeholder="gpt-3.5-turbo"></div>
                </div>
            </div>
            <div class="form-section">
                <div class="action-btn" onclick="saveConfig()">保存设置</div>
                <div class="action-btn action-cancel" onclick="resetData()" style="margin-top:20px;">重置所有数据</div>
            </div>
        </div>
        <div class="home-bar"></div>
    </div>

    <div id="screen-creator" class="app-win" style="z-index: 600;">
        <div class="nav">
            <div class="nav-btn" onclick="closeCreator()">取消</div>
            <div class="nav-title">新建人物</div>
            <div class="nav-btn" style="font-weight:bold;" onclick="saveCreator()">完成</div>
        </div>
        <div class="content-scroll" style="background: #f2f2f7;">
            <div class="img-upload-box">
                <div class="img-preview" id="cr-avatar-preview"></div>
                <div class="btn-upload" onclick="randomAvatar()">随机头像</div>
                <input id="cr-avatar" type="hidden">
            </div>

            <div class="form-section">
                <div class="form-header">基本信息</div>
                <div class="form-card">
                    <div class="form-row"><span class="form-label">姓名</span><input id="cr-name" class="form-input" placeholder="例如：祁煜"></div>
                    <div class="form-row">
                        <span class="form-label">世界书</span>
                        <select id="cr-world" class="form-input" style="direction: rtl;">
                            <option value="">无</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="form-header">人设详情 (Persona)</div>
                <div class="form-card" style="padding:10px;">
                    <textarea id="cr-persona" class="form-textarea" placeholder="性格、外貌、说话风格..."></textarea>
                </div>
            </div>

            <div class="form-section">
                <div class="form-header">背景故事 (Background)</div>
                <div class="form-card" style="padding:10px;">
                    <textarea id="cr-bg" class="form-textarea" placeholder="他/她的过去，以及现在的处境..."></textarea>
                </div>
            </div>

            <div class="form-section">
                <div class="form-header">关系网 (Relationships)</div>
                <div class="form-card" style="padding:10px;">
                    <textarea id="cr-rel" class="form-textarea" placeholder="与其他角色的关系，以及对玩家(User)的态度..."></textarea>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-lore-creator" class="app-win" style="z-index: 600;">
        <div class="nav">
            <div class="nav-btn" onclick="closeLoreCreator()">取消</div>
            <div class="nav-title">新建世界书</div>
            <div class="nav-btn" style="font-weight:bold;" onclick="saveLore()">完成</div>
        </div>
        <div class="content-scroll">
            <div class="form-section">
                <div class="form-header">标题</div>
                <div class="form-card">
                    <div class="form-row"><input id="lore-title" class="form-input" style="text-align:left;" placeholder="例如：赛博朋克2077设定集"></div>
                </div>
            </div>
            <div class="form-section">
                <div class="form-header">世界观内容 (Global Context)</div>
                <div class="form-card" style="padding:10px;">
                    <textarea id="lore-content" class="form-textarea" style="height:300px;" placeholder="在此输入世界观、地理、魔法系统、专有名词等设定。此内容将在对话时作为系统背景发送给AI。"></textarea>
                </div>
            </div>
        </div>
    </div>

    <div id="chat-view" class="chat-view">
        <div class="nav" style="background:#f9f9f9;">
            <div class="nav-btn" onclick="exitChat()"><i class="fas fa-chevron-left"></i> 消息</div>
            <div class="nav-title" id="chat-title">Chat</div>
            <div class="nav-btn"><i class="fas fa-user"></i></div>
        </div>
        <div class="chat-body" id="chat-box"></div>
        <div style="padding:10px; background:#f9f9f9; border-top:1px solid #ccc; display:flex; gap:10px; padding-bottom:max(10px, var(--safe-bottom));">
            <input id="chat-input" style="flex:1; padding:10px; border-radius:20px; border:1px solid #ddd; font-size:16px;" placeholder="发送消息...">
            <button onclick="sendMsg()" style="border:none; background:none; color:var(--ios-blue); font-weight:bold; font-size:16px;">发送</button>
        </div>
    </div>

    <div class="action-sheet-mask" id="action-mask" onclick="closeActionSheet()">
        <div class="action-sheet" id="action-sheet">
            <div class="action-btn" onclick="openCreator()">新建人物</div>
            <div class="action-btn" onclick="importCard()">导入酒馆卡 (JSON)</div>
            <div class="action-btn" onclick="openCreateWorld()">新建世界书</div>
            <div class="action-btn action-cancel" onclick="closeActionSheet()">取消</div>
        </div>
    </div>

<script>
    /* --- 数据管理 --- */
    const STORAGE_KEY = 'os_pro_data_v1';
    
    // 默认数据结构
    let sys = { pass: null, api: '', key: '', model: 'gpt-3.5-turbo' };
    let data = {
        users: [],      // {id, name, avatar, persona, background, relation, worldId}
        worlds: [],     // {id, title, content}
        chats: {}       // {userId: [msg]}
    };

    // 运行时状态
    let passInput = [];
    let isSettingPass = false;
    let activeUserId = null;

    /* --- 初始化 --- */
    window.onload = () => {
        loadData();
        updateTime();
        setInterval(updateTime, 1000);
        renderPassPad();
        
        // 绑定底部条回桌面
        document.querySelectorAll('.home-bar').forEach(b => b.addEventListener('click', goHome));
        document.getElementById('chat-input').addEventListener('keypress', (e)=>{if(e.key==='Enter') sendMsg()});
        
        // 刷新列表
        renderLists();
        
        // 填充设置
        document.getElementById('cfg-url').value = sys.api;
        document.getElementById('cfg-key').value = sys.key;
        document.getElementById('cfg-model').value = sys.model;
    };

    function loadData() {
        const local = localStorage.getItem(STORAGE_KEY);
        if(local) {
            const parsed = JSON.parse(local);
            if(parsed.sys) sys = parsed.sys;
            if(parsed.data) data = parsed.data;
        }
    }

    function saveData() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify({ sys, data }));
    }

    function updateTime() {
        const d = new Date();
        const t = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        document.getElementById('sb-time').innerText = t;
        document.getElementById('lock-time').innerText = t;
    }

    /* --- 锁屏逻辑 --- */
    function tryUnlock() {
        if(!sys.pass && !isSettingPass) { isSettingPass = true; showPass("设置新密码"); }
        else showPass("输入密码");
    }
    function showPass(txt) {
        document.getElementById('lock-screen').style.transform = 'translateY(-100%)';
        const pl = document.getElementById('pass-layer');
        pl.style.display = 'flex';
        setTimeout(()=>pl.style.opacity='1',10);
        document.getElementById('pass-hint').innerText = txt;
        passInput = []; updateDots();
    }
    function renderPassPad() {
        const p = document.getElementById('numpad');
        [1,2,3,4,5,6,7,8,9,0].forEach(n=>{
            const b = document.createElement('div');
            b.className='num-btn'; b.innerText=n;
            b.onclick=()=>inputPass(n);
            if(n===0) b.style.gridColumnStart='2';
            p.appendChild(b);
        });
    }
    function inputPass(n) {
        if(passInput.length<4) {
            passInput.push(n); updateDots();
            if(passInput.length===4) setTimeout(checkPass,200);
        }
    }
    function updateDots() {
        const ds = document.querySelectorAll('.p-dot');
        ds.forEach((d,i)=> i<passInput.length ? d.classList.add('fill') : d.classList.remove('fill'));
    }
    function checkPass() {
        const code = passInput.join('');
        if(isSettingPass) {
            sys.pass = code; isSettingPass = false; saveData();
            alert("密码已设置"); enterDesk();
        } else {
            if(code === sys.pass) enterDesk();
            else { alert("错误"); passInput=[]; updateDots(); }
        }
    }
    function enterDesk() {
        document.getElementById('pass-layer').style.display='none';
        document.getElementById('lock-screen').style.display='none';
    }

    /* --- App 导航 --- */
    function openApp(id) { document.getElementById('app-'+id).style.display='flex'; }
    function closeApp(id) { document.getElementById('app-'+id).style.display='none'; }
    function goHome(e) {
        if(e) e.stopPropagation();
        document.querySelectorAll('.app-win').forEach(w=>w.style.display='none');
        document.getElementById('chat-view').style.transform='translateX(100%)';
        closeActionSheet();
    }

    /* --- Action Sheet (高级菜单) --- */
    function openActionSheet() {
        const mask = document.getElementById('action-mask');
        mask.style.display = 'flex';
        setTimeout(()=> document.getElementById('action-sheet').style.transform='translateY(0)', 10);
    }
    function closeActionSheet() {
        document.getElementById('action-sheet').style.transform='translateY(100%)';
        setTimeout(()=> document.getElementById('action-mask').style.display='none', 300);
    }

    /* --- 列表渲染 --- */
    function renderLists() {
        // QQ列表
        const qqList = document.getElementById('qq-list');
        qqList.innerHTML = '';
        data.users.forEach(u => {
            const div = document.createElement('div');
            div.className = 'list-item';
            div.onclick = () => openChat(u.id);
            // 获取最后消息
            const msgs = data.chats[u.id] || [];
            const last = msgs.length ? msgs[msgs.length-1].content : (u.persona.substring(0,15)+"...");
            
            div.innerHTML = `
                <div class="av-small" style="background-image:url('${u.avatar}')"></div>
                <div>
                    <div class="txt-main">${u.name}</div>
                    <div class="txt-sub">${last}</div>
                </div>
            `;
            qqList.appendChild(div);
        });

        // 通讯录列表
        const phList = document.getElementById('phone-list');
        phList.innerHTML = '';
        data.users.forEach(u => {
            phList.innerHTML += `
                <div class="list-item">
                    <div class="av-small" style="background-image:url('${u.avatar}')"></div>
                    <div class="txt-main">${u.name}</div>
                </div>`;
        });

        // 世界书列表
        const loreList = document.getElementById('lore-list');
        loreList.innerHTML = '';
        data.worlds.forEach(w => {
            loreList.innerHTML += `
                <div class="list-item" onclick="alert('编辑功能待开发，请直接新建')">
                    <div class="txt-main">${w.title}</div>
                </div>`;
        });
    }

    /* --- 创建人物 (Creator Logic) --- */
    function openCreator() {
        closeActionSheet();
        // 重置表单
        document.getElementById('cr-name').value = '';
        document.getElementById('cr-persona').value = '';
        document.getElementById('cr-bg').value = '';
        document.getElementById('cr-rel').value = '';
        randomAvatar();
        
        // 填充世界书选项
        const sel = document.getElementById('cr-world');
        sel.innerHTML = '<option value="">无链接</option>';
        data.worlds.forEach(w => {
            sel.innerHTML += `<option value="${w.id}">${w.title}</option>`;
        });

        document.getElementById('screen-creator').style.display = 'flex';
    }

    function closeCreator() { document.getElementById('screen-creator').style.display = 'none'; }
    
    function randomAvatar() {
        const seed = Date.now();
        const url = `https://api.dicebear.com/7.x/avataaars/svg?seed=${seed}`;
        document.getElementById('cr-avatar').value = url;
        document.getElementById('cr-avatar-preview').style.backgroundImage = `url('${url}')`;
    }

    function saveCreator() {
        const name = document.getElementById('cr-name').value;
        if(!name) return alert("请输入名字");
        
        const newUser = {
            id: Date.now().toString(),
            name: name,
            avatar: document.getElementById('cr-avatar').value,
            persona: document.getElementById('cr-persona').value,
            background: document.getElementById('cr-bg').value,
            relation: document.getElementById('cr-rel').value,
            worldId: document.getElementById('cr-world').value
        };
        
        data.users.push(newUser);
        saveData();
        renderLists();
        closeCreator();
    }

    function importCard() {
        const jsonStr = prompt("请粘贴酒馆人物卡JSON内容:");
        if(!jsonStr) return;
        try {
            const card = JSON.parse(jsonStr);
            // 简单适配 V2 格式
            const spec = card.data || card; 
            const name = spec.name || "未命名";
            const newUser = {
                id: Date.now().toString(),
                name: name,
                avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${name}`, // 暂时无法处理Base64图片，用随机代替
                persona: spec.description || spec.persona || "",
                background: spec.first_mes || "", 
                relation: "",
                worldId: ""
            };
            data.users.push(newUser);
            saveData();
            renderLists();
            alert("导入成功");
            closeActionSheet();
        } catch(e) {
            alert("JSON 格式错误");
        }
    }

    /* --- 创建世界书 --- */
    function openCreateWorld() {
        closeActionSheet();
        document.getElementById('lore-title').value = '';
        document.getElementById('lore-content').value = '';
        document.getElementById('screen-lore-creator').style.display = 'flex';
    }
    function closeLoreCreator() { document.getElementById('screen-lore-creator').style.display = 'none'; }
    function saveLore() {
        const title = document.getElementById('lore-title').value;
        const content = document.getElementById('lore-content').value;
        if(!title) return alert("请输入标题");
        
        data.worlds.push({ id: Date.now().toString(), title, content });
        saveData();
        renderLists();
        closeLoreCreator();
    }

    /* --- 聊天与 AI --- */
    function openChat(uid) {
        activeUserId = uid;
        const u = data.users.find(x=>x.id===uid);
        document.getElementById('chat-title').innerText = u.name;
        document.getElementById('chat-view').style.transform = 'translateX(0)';
        renderChat();
    }
    function exitChat() {
        document.getElementById('chat-view').style.transform = 'translateX(100%)';
        activeUserId = null;
        renderLists();
    }
    function renderChat() {
        const box = document.getElementById('chat-box');
        box.innerHTML = '';
        const msgs = data.chats[activeUserId] || [];
        msgs.forEach(m => {
            const b = document.createElement('div');
            b.className = `bubble ${m.role}`;
            b.innerText = m.content;
            box.appendChild(b);
        });
        box.scrollTop = box.scrollHeight;
    }

    async function sendMsg() {
        const input = document.getElementById('chat-input');
        const txt = input.value.trim();
        if(!txt || !activeUserId) return;
        
        // Save User Msg
        if(!data.chats[activeUserId]) data.chats[activeUserId] = [];
        data.chats[activeUserId].push({role:'me', content:txt});
        saveData();
        renderChat();
        input.value = '';

        // AI Thinking
        const loading = document.createElement('div');
        loading.className = 'bubble ai'; loading.innerText = '...';
        document.getElementById('chat-box').appendChild(loading);

        try {
            const user = data.users.find(u=>u.id===activeUserId);
            // 获取世界书内容
            let worldInfo = "";
            if(user.worldId) {
                const w = data.worlds.find(x=>x.id===user.worldId);
                if(w) worldInfo = `[World Info: ${w.content}]\n`;
            }

            // 构造强力 Prompt
            const systemPrompt = `${worldInfo}
你正在扮演角色：${user.name}。
[Character Persona]: ${user.persona}
[Background]: ${user.background}
[Relationship]: ${user.relation}
请沉浸式扮演，用符合人物设定的语气回复。`;

            const reply = await callAPI(txt, systemPrompt, data.chats[activeUserId]);
            
            // Save AI Msg
            data.chats[activeUserId].push({role:'ai', content:reply});
            saveData();
            loading.remove();
            renderChat();
        } catch(e) {
            loading.innerText = "Error: " + e.message;
        }
    }

    async function callAPI(msg, prompt, history) {
        if(!sys.key) return "请在设置中配置API Key (模拟回复)";
        
        let msgs = [{role:'system', content:prompt}];
        history.forEach(h => {
             if(h.content!=='...') msgs.push({role:h.role==='me'?'user':'assistant', content:h.content});
        });
        
        let url = sys.api;
        if(!url.includes('/chat/completions')) url = url.replace(/\/$/,'') + '/chat/completions';

        const res = await fetch(url, {
            method: 'POST',
            headers: {'Content-Type':'application/json', 'Authorization':'Bearer '+sys.key},
            body: JSON.stringify({ model: sys.model, messages: msgs })
        });
        const json = await res.json();
        return json.choices[0].message.content;
    }

    function saveConfig() {
        sys.api = document.getElementById('cfg-url').value;
        sys.key = document.getElementById('cfg-key').value;
        sys.model = document.getElementById('cfg-model').value;
        saveData(); alert("保存成功"); closeApp('settings');
    }
    
    function resetData() {
        if(confirm("确定清空？")) { localStorage.clear(); location.reload(); }
    }

</script>
</body>
</html>
